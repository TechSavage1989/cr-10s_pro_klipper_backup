; -------------------------------------------------------------------------
; Section: PID Tuning (Extruder & Bed) — Fixed
; -------------------------------------------------------------------------
[gcode_macro PID_TUNE_SELECT]
# Fluidd shows only TYPE, PRESET, TEMP—STEP is internal.
params:
  TYPE:
  PRESET:
  TEMP:
description: >
  Calibrate Extruder or Bed PID via presets or custom TEMP.
  Runs PID_CALIBRATE, saves config, notifies when done.
gcode:
  {% set extruder_PLA = 200 %}  {% set extruder_ABS = 240 %}  {% set extruder_PETG = 230 %}
  {% set bed_PLA      =  60 %}  {% set bed_ABS      = 100 %}  {% set bed_PETG     =  80 %}

  {% if not params.STEP %}
    # Step 1: select heater
    RESPOND TYPE=command MSG="action:prompt_begin Select heater"
    RESPOND TYPE=command MSG="action:prompt_button Extruder|PID_TUNE_SELECT STEP=heater TYPE=extruder;action:prompt_end|primary"
    RESPOND TYPE=command MSG="action:prompt_button Bed     |PID_TUNE_SELECT STEP=heater TYPE=bed;action:prompt_end|secondary"
    RESPOND TYPE=command MSG="action:prompt_show"

  {% elif params.STEP == 'heater' %}
    # Step 2: select preset or custom
    {% if params.TYPE == 'extruder' %}
      RESPOND TYPE=command MSG="action:prompt_begin Extruder PID temp"
      RESPOND TYPE=command MSG="action:prompt_button PLA|PID_TUNE_SELECT STEP=run TYPE=extruder PRESET=PLA;action:prompt_end|primary"
      RESPOND TYPE=command MSG="action:prompt_button ABS|PID_TUNE_SELECT STEP=run TYPE=extruder PRESET=ABS;action:prompt_end|secondary"
      RESPOND TYPE=command MSG="action:prompt_button PETG|PID_TUNE_SELECT STEP=run TYPE=extruder PRESET=PETG;action:prompt_end|info"
      RESPOND TYPE=command MSG="action:prompt_input Custom temp (°C)|TEMP|200"
      RESPOND TYPE=command MSG="action:prompt_footer_button Calibrate|PID_TUNE_SELECT STEP=run TYPE=extruder TEMP={TEMP};action:prompt_end|warning"
    {% else %}
      RESPOND TYPE=command MSG="action:prompt_begin Bed PID temp"
      RESPOND TYPE=command MSG="action:prompt_button PLA|PID_TUNE_SELECT STEP=run TYPE=bed PRESET=PLA;action:prompt_end|primary"
      RESPOND TYPE=command MSG="action:prompt_button ABS|PID_TUNE_SELECT STEP=run TYPE=bed PRESET=ABS;action:prompt_end|secondary"
      RESPOND TYPE=command MSG="action:prompt_button PETG|PID_TUNE_SELECT STEP=run TYPE=bed PRESET=PETG;action:prompt_end|info"
      RESPOND TYPE=command MSG="action:prompt_input Custom temp (°C)|TEMP|60"
      RESPOND TYPE=command MSG="action:prompt_footer_button Calibrate|PID_TUNE_SELECT STEP=run TYPE=bed TEMP={TEMP};action:prompt_end|warning"
    {% endif %}
    RESPOND TYPE=command MSG="action:prompt_show"

  {% else %}
    # Step 3: run calibration
    RESPOND TYPE=command MSG="action:prompt_end"

    {% if params.TYPE == 'extruder' %}
      {% if params.PRESET == 'PLA' %}
        {% set temp = extruder_PLA %}
      {% elif params.PRESET == 'ABS' %}
        {% set temp = extruder_ABS %}
      {% elif params.PRESET == 'PETG' %}
        {% set temp = extruder_PETG %}
      {% else %}
        {% set temp = params.TEMP|int %}
      {% endif %}
      {% set heater_id = 'extruder' %}
      {% set name      = 'Extruder' %}
    {% else %}
      {% if params.PRESET == 'PLA' %}
        {% set temp = bed_PLA %}
      {% elif params.PRESET == 'ABS' %}
        {% set temp = bed_ABS %}
      {% elif params.PRESET == 'PETG' %}
        {% set temp = bed_PETG %}
      {% else %}
        {% set temp = params.TEMP|int %}
      {% endif %}
      {% set heater_id = 'heater_bed' %}
      {% set name      = 'Bed' %}
    {% endif %}

    RESPOND TYPE=echo MSG="⌛ Calibrating {name} PID at {temp}°C"
    PID_CALIBRATE HEATER={heater_id} TARGET={temp}
    SAVE_CONFIG
    RESPOND TYPE=command MSG="action:notify {name} PID tuned at {temp}°C complete"
  {% endif %}
